\chapter{Конструкторская часть}

\section{Проектирование базы данных}
\subsection{Таблицы базы данных}

Реализуемая база данных должна включать десять таблиц: шесть из них соответсвуют
cущностям, описанным в подразделе~\ref{head:01}, а оставшиеся четыре реализуют
связь между сущностями. Диаграмма базы данных представлена на
рисунке~\ref{img:UML-ER}.

\imgh{UML-ER}{h!}{17cm}{Диаграмма базы данных}

Приведем, подробное описание каждой таблицы.
\begin{enumerate}
    \item Таблица BoardGameEvent содержит информацию об игротеках и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item Title --- название, строковый тип;
            \item Date --- дата проведения, тип даты;
            \item StartTime --- время начала, тип времени;
            \item Duration --- продолжительность в минутах, целочисленный
                беззнаковый тип;
            \item Cost --- стоимость посещения, целочисленный беззнаковый тип;
            \item Purchase --- возможность покупки игр, логический тип;
            \item BeginRegistration --- время начала регистрации, тип
                даты-времени (timestamp);
            \item EndRegistration --- время окончания регистрации, тип
                даты-времени (timestamp);
            \item Cancelled --- состояние отмены, логический тип;
            \item VenueID --- ID места проведения, внешний ключ;
            \item OrganizerID --- ID организатора, внешний ключ.
        \end{itemize}
    \item Таблица BoardGame содержит информацию о настольных играх и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item Title --- название, строковый тип;
            \item Producer --- издатель, строковый тип;
            \item Year --- год издания, целочисленный беззнаковый тип;
            \item MinAge --- минимальный возраст игроков, целочисленный
                беззнаковый тип;
            \item MaxAge --- максимальный возраст игроков, целочисленный
                беззнаковый тип;
            \item MinPlayerNum --- минимальное число игроков, целочисленный
                беззнаковый тип;
            \item MaxPlayerNum --- максимальное число игроков, целочисленный
                беззнаковый тип;
            \item MinDuration --- минимальное время партии в минутах,
                целочисленный беззнаковый тип;
            \item MaxDuration --- максимальное время партии, целочисленный
                беззнаковый тип.
        \end{itemize}
    \item Таблица Venue содержит информацию о местах проведения и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item Name --- название, строковый тип;
            \item Address --- адрес, строковый тип;
            \item Email --- адрес электронной почты, строковый тип;
            \item URL --- интернет-адрес, строковый тип;
            \item PhoneNumber --- номер телефона, строковый тип;
            \item Type --- тип места проведения, строковый тип.
        \end{itemize}
    \item Таблица Organzer содержит информацию об организаторах и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item Name --- название, строковый тип;
            \item Address --- адрес, строковый тип;
            \item Email --- адрес электронной почты, строковый тип;
            \item URL --- интернет-адрес, строковый тип;
            \item PhoneNumber --- номер телефона, строковый тип;
        \end{itemize}
    \item Таблица Player содержит информацию об игроках и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item Name --- имя игрока, строковый тип;
            \item Rating --- рейтинг, целочисленный тип;
            \item League --- лига игрока, строковый тип.
        \end{itemize}
    \item Таблица User содержит информацию об пользователях и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item Name --- имя пользователя, строковый тип;
            \item Password --- хеш пароля, строковый тип.
        \end{itemize}
    \item Таблица Role содержит информацию о ролях пользователей и включает
        следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item ID --- первичный ключ, целочисленный тип;
            \item RoleName --- название роли (<<guest>>, <<player>>,
                <<organizer>>, <<admin>>), строковый тип;
            \item RoleID --- ID в таблице игроков или организаторов, внешний
                ключ;
            \item UserID --- ID пользователя, внешний ключ.
        \end{itemize}
    \item Таблица EventGameRelations реализует связь многие-ко-многим таблиц
        BoardGameEvent и BoardGame  и включает следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item BoardGameID --- ID настольной игры, часть составного
                первичного ключа, внешний ключ;
            \item BoardGameEventID --- ID игротеки, часть составного
                первичного ключа, внешний ключ.
        \end{itemize}
    \item Таблица Favorites реализует связь многие-ко-многим таблиц
        Player и BoardGame  и включает следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item BoardGameID --- ID настольной игры, часть составного
                первичного ключа, внешний ключ;
            \item PlayerID --- ID игрока, часть составного
                первичного ключа, внешний ключ.
        \end{itemize}
    \item Таблица Registrations реализует связь многие-ко-многим таблиц
        BoardGameEvent и Player и включает следующие поля:
        \begin{itemize}[leftmargin=\parindent]
            \item PlayerID --- ID игрока, часть составного
                первичного ключа, внешний ключ;
            \item BoardGameEventID --- ID игротеки, часть составного
                первичного ключа, внешний ключ.
        \end{itemize}
\end{enumerate}


\subsection{Хранимые процедуры и функции базы данных}

Для выполнения правил делового регламента в базе данных должны быть определены
следующие хранимые процедуры и функции:
\begin{itemize}
    \item функция, которая реализует алгоритм получения состояния игротеки,
        представленный на рисунке~\ref{img:GetState};
    \item процедура обновления таблицы-связи игр и игротек, реализующая
        алгоритм, представленный на рисунке~\ref{img:UpdateEG}.
\end{itemize}

\imgw{GetState}{h!}{16.5cm}{Алгоритм получения состояния игротеки}
\imgw{UpdateEG}{h!}{12cm}{Алгоритм обновления таблицы-связи игр и игротек}

\subsection{Триггеры базы данных}

Для запрета игроку добавления своей регистрации на игротеку, которая уже
завершилась, в базе данных должен быть определен <<BEFORE INSERT>> триггер,
алгоритм работы которого представлен на рисунке~\ref{img:CheckRegTime}.

\imgw{CheckRegTime}{h!}{13cm}{Алгоритм проверки времени регистрации}

\subsection{Роли базы данных}

Для обеспечения безопасности сервера базы данных должны быть определены
следующие роли пользователей:

\begin{itemize}
    \item \textbf{Гость или неавторизованный пользователь}, который должен иметь
        возможность чтения записей из таблиц игротек, настольных игр, их
        таблицы-связи, а также таблиц организаторов и мест проведения.
    \item \textbf{Игрок}, который должен иметь все возможности неавторизованного
        пользователя, а также возможность чтения таблиц игроков, избранных игр и
        регистраций, возможность обновления первой из них и вставки/удаления из
        двух последних.
    \item \textbf{Организатор} должен обладать теми же правами, что и гость, а
        также иметь возможность чтения таблиц игроков и регистраций, вставки в
        таблицу игротек и обновления записей в таблице игротек и организаторов.
    \item \textbf{Администратор} должен иметь возможность проводить все
        возможные операции над всеми таблицами в базе данных.
\end{itemize}

\section{Проектирование приложения}

Структурно приложение строится на парадигмах ООП. На верхнем уровне выделено три
компонента: компонент доступа к данным, через который происходит обращение к
базе данных, компонент бизнес-логики и компонент пользовательского интерфеса.
На рисунке~\ref{img:SWstruct} показаны классы первых двух компонентов.
Связь между компонентом доступа к данным и компонентом бизнес-логики построена
на основе паттерна репозиторий, обращение же компонента пользовательского
интерфейса к сервисам происходит через их интерфейсы.

\section*{Вывод}

В данном разделе была спроектирована база данных: описаны таблицы, хранимые
процедуры и функции, триггеры и роли, --- а также была описана структура
приложения.

\clearpage
\imgw{SWstruct}{h!}{17cm}{Компоненты бизнес-логики и доступа к данным}
~\\
~\\
~\\
